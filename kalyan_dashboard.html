<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Matka Ultimate Dashboard</title>
<style>
    :root { --gold: #ffd700; --red: #ff3e3e; --bg: #0a0a0a; --panel: #1a1a1a; --text: #eee; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; overflow-x: hidden; }
    
    /* Navigation Bar */
    .nav-bar { background: #000; border-bottom: 2px solid var(--gold); padding: 10px; position: sticky; top: 0; z-index: 1000; display: flex; gap: 10px; overflow-x: auto; white-space: nowrap; }
    .nav-btn { background: var(--panel); color: var(--gold); border: 1px solid var(--gold); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.3s; }
    .nav-btn.active { background: var(--gold); color: #000; }

    /* Main Container */
    .container { padding: 15px; max-width: 1200px; margin: auto; }
    .page-section { display: none; animation: fadeIn 0.4s ease; }
    .page-section.active { display: block; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Table Styling */
    .table-container { position: relative; background: #fff; border-radius: 8px; overflow: hidden; display: inline-block; box-shadow: 0 0 20px rgba(255,215,0,0.2); }
    table { border-collapse: collapse; font-size: 13px; color: #000; }
    td, th { border: 1px solid #ccc; padding: 10px; text-align: center; font-weight: bold; width: 40px; height: 40px; }
    th { background: #800000; color: white; }
    .blank { background: #e0e0e0 !important; cursor: pointer; border: 1.5px dashed #777; }
    .circle { border: 3px solid var(--red); border-radius: 50%; background: rgba(255,0,0,0.1); z-index: 5; }
    .base-anchor { background: rgba(255,165,0,0.4) !important; border: 3px solid #ff8c00 !important; }

    /* Dashboard Cards */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
    .card { background: var(--panel); padding: 15px; border-radius: 10px; border-top: 4px solid var(--gold); text-align: center; }
    .card h3 { margin: 0 0 10px 0; font-size: 14px; color: var(--gold); text-transform: uppercase; }
    .stat { font-size: 24px; font-weight: bold; letter-spacing: 2px; }

    /* Tools Bar */
    .tools { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    button.tool-btn { background: #333; color: #fff; border: 1px solid #555; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }
    
    canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 3; }

    /* Popup */
    #popup { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border: 4px solid var(--gold); display: none; z-index: 2000; padding: 15px; border-radius: 10px; color: #000; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; z-index: 1500; }
</style>
</head>
<body>

<div class="nav-bar">
    <button class="nav-btn active" onclick="showPage('searchPage', this)">üîç Pattern Search</button>
    <button class="nav-btn" onclick="showPage('strongPage', this)">üíé Strong 3-Ank</button>
    <button class="nav-btn" onclick="showPage('aiPage', this)">ü§ñ Future AI</button>
    <button class="nav-btn" onclick="showPage('dataPage', this)">üìÇ Manage Data</button>
</div>

<div class="container">
    
    <div class="tools">
        <button class="tool-btn" onclick="addRow()">‚ûï Add New Row</button>
        <button class="tool-btn" onclick="saveData()" style="background: #28a745;">üíæ Save All Data</button>
        <button class="tool-btn" onclick="document.getElementById('csv').click()">üì§ Import CSV</button>
        <input type="file" id="csv" style="display:none">
    </div>

    <center>
        <div class="table-container">
            <canvas id="mainCanvas"></canvas>
            <table id="tbl"></table>
        </div>
    </center>

    <hr style="border: 0.5px solid #333; margin: 25px 0;">

    <div id="searchPage" class="page-section active">
        <div class="dashboard-grid">
            <div class="card">
                <h3>Found Matches</h3>
                <div id="searchMatches" style="font-size: 12px;">Click a blank box to search...</div>
            </div>
            <div class="card">
                <h3>Family Groups</h3>
                <div id="familyInfo" style="font-size: 12px; color: #aaa;">Search a pattern to see families</div>
            </div>
        </div>
    </div>

    <div id="strongPage" class="page-section">
        <div class="dashboard-grid">
            <div class="card">
                <h3>Strong 3 Jodi</h3>
                <div id="topJodis" class="stat">--</div>
            </div>
            <div class="card">
                <h3>Strong 3 Ank</h3>
                <div id="topAnks" class="stat">--</div>
            </div>
        </div>
    </div>

    <div id="aiPage" class="page-section">
        <div class="card" style="max-width: 500px; margin: auto;">
            <h3>üîÆ AI Probable Target</h3>
            <div id="aiPrediction" class="stat" style="color: var(--gold);">Waiting for Pattern</div>
            <p style="font-size: 11px; color: #888; margin-top: 10px;">Based on deep column history & repetition patterns</p>
        </div>
    </div>

</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div id="popup">
    <button onclick="closePopup()" style="float:right; background:red; color:#fff; border:none; padding:5px; border-radius:5px;">CLOSE</button>
    <h3 style="margin:0 0 10px 0; font-size: 14px; text-align: center;">Logic Connection View</h3>
    <div class="table-container" style="border: 1px solid #000;">
        <canvas id="popCanvas"></canvas>
        <div id="popData"></div>
    </div>
</div>

<script>
const STORAGE_KEY="matka_all_in_one";
let targetCol = null;
const families={"12":["12","17","21","26","62","67","71","76"],"13":["13","18","31","36","63","68","81","86"],"14":["14","19","41","46","64","69","91","96"],"15":["01","06","10","15","51","56","60","65"],"23":["23","28","32","37","73","78","82","87"],"24":["24","29","42","47","74","79","92","97"],"25":["02","07","20","25","52","57","70","75"],"34":["34","39","43","48","84","89","93","98"],"35":["03","08","30","35","53","58","80","85"],"45":["04","09","40","45","54","59","90","95"],"HR":["05","16","27","38","49","50","61","72","83","94"],"FR":["00","11","22","33","44","55","66","77","88","99"]};

function showPage(pageId, btn) {
    document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    btn.classList.add('active');
}

function norm(v){if(v==""||v=="**")return "**"; v=String(v); return v.length==1?"0"+v:v;}
function smartMatch(a,b){ if(a=="**"||b=="**") return false; return a===b || b===(v=>v[1]+v[0])(a) || (f=>Object.keys(families).find(k=>families[k].includes(f)))(a) === (f=>Object.keys(families).find(k=>families[k].includes(f)))(b); }

let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [["51","91","41","57","19","95"],["05","90","74","06","19","63"],["**","**","**","**","**","**"]];
data = data.map(r => r.map(norm));

let activeMark = null;

function draw() {
    let h = "<tr><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr>";
    data.forEach((r, ri) => {
        h += "<tr>";
        r.forEach((c, ci) => {
            let cls = (activeMark && isPartOfPattern(ri, ci)) ? "circle" : "";
            if(c=="**") cls += " blank";
            if(activeMark && ri == (activeMark.start + activeMark.baseRowRel) && ci == targetCol) cls += " base-anchor";
            h += `<td class="${cls}" contenteditable oninput="edit(${ri},${ci},this)" onclick="${c=='**'?'runLogic('+ri+','+ci+')':'' }">${c}</td>`;
        });
        h += "</tr>";
    });
    document.getElementById("tbl").innerHTML = h;
    if(activeMark) setTimeout(() => drawLines("mainCanvas", document.getElementById("tbl")), 50);
}

function isPartOfPattern(ri, ci){
    if(!activeMark) return false;
    let i = ri - activeMark.start;
    return (i >= 0 && i < activeMark.shape.length && activeMark.shape[i][ci]);
}

function drawLines(cvsId, tblEl) {
    const cvs = document.getElementById(cvsId);
    const ctx = cvs.getContext("2d");
    cvs.width = tblEl.offsetWidth; cvs.height = tblEl.offsetHeight;
    ctx.clearRect(0,0,cvs.width,cvs.height);
    const cells = tblEl.querySelectorAll(".circle");
    if(cells.length < 2) return;
    const tRect = tblEl.getBoundingClientRect();
    const anchor = tblEl.querySelector(".base-anchor") || cells[cells.length-1];
    const aR = anchor.getBoundingClientRect();
    const x1 = aR.left - tRect.left + aR.width/2;
    const y1 = aR.top - tRect.top + aR.height/2;
    ctx.strokeStyle = "red"; ctx.lineWidth = 2;
    cells.forEach(c => {
        const r = c.getBoundingClientRect();
        ctx.beginPath(); ctx.moveTo(x1,y1);
        ctx.lineTo(r.left - tRect.left + r.width/2, r.top - tRect.top + r.height/2);
        ctx.stroke();
    });
}

function runLogic(r, c) {
    targetCol = c;
    let base = "**", baseIdx = -1;
    for(let i=r-1; i>=0; i--) { if(data[i][c] != "**") { base = data[i][c]; baseIdx = i; break; } }
    if(base == "**") return;

    let shape = [];
    let startR = Math.max(0, r-4);
    for(let i=startR; i<=r; i++) {
        let row = [];
        for(let j=0; j<6; j++) row.push(data[i][j] != "**" && smartMatch(data[i][j], base) ? 1 : 0);
        shape.push(row);
    }

    let matches = [];
    for(let i=0; i<=data.length-shape.length; i++) {
        if(smartMatch(data[i + (baseIdx-startR)][c], base)) {
            let ok = true;
            for(let k=0; k<shape.length; k++) {
                for(let j=0; j<6; j++) if(shape[k][j] && !smartMatch(data[i+k][j], base)) { ok=false; break; }
            }
            if(ok) matches.push({index: i});
        }
    }

    updateDashboard(shape, matches, (baseIdx-startR));
}

function updateDashboard(shape, matches, baseRel) {
    let checkDiv = document.getElementById("searchMatches");
    checkDiv.innerHTML = "";
    matches.slice(0,3).forEach((m, i) => {
        let d = document.createElement("div");
        d.style = "background:#333; margin:5px; padding:8px; cursor:pointer; border-radius:5px;";
        d.innerText = `Pattern Match ${i+1} (Row ${m.index+1})`;
        d.onclick = () => { activeMark={start:m.index, shape:shape, baseRowRel: baseRel}; draw(); showOne(shape, m.index, baseRel); };
        checkDiv.appendChild(d);
    });

    // AI & Strong Calculations
    let jc = {}, dc = {};
    matches.forEach(m => {
        let nr = m.index + shape.length;
        if(nr < data.length && data[nr][targetCol] != "**") {
            let v = data[nr][targetCol];
            jc[v] = (jc[v]||0)+1; dc[v[0]] = (dc[v[0]]||0)+1; dc[v[1]] = (dc[v[1]]||0)+1;
        }
    });

    let topJ = Object.entries(jc).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);
    let topA = Object.entries(dc).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);

    document.getElementById("topJodis").innerText = topJ.length ? topJ.join(", ") : "--";
    document.getElementById("topAnks").innerText = topA.length ? topA.join(", ") : "--";
    document.getElementById("aiPrediction").innerText = topJ[0] || "No Data";
}

function showOne(shape, idx, baseRel) {
    let html = "<table>";
    for(let i=0; i<shape.length; i++) {
        html += "<tr>";
        data[idx+i].forEach((v, j) => {
            let cls = shape[i][j] ? 'circle' : '';
            if(i == baseRel && j == targetCol) cls += ' base-anchor';
            html += `<td class="${cls}">${v}</td>`;
        });
        html += "</tr>";
    }
    document.getElementById("popData").innerHTML = html + "</table>";
    document.getElementById("popup").style.display = "block";
    document.getElementById("overlay").style.display = "block";
    setTimeout(() => drawLines("popCanvas", document.getElementById("popData").querySelector("table")), 100);
}

function edit(r,c,el){ data[r][c] = norm(el.innerText.trim()); }
function addRow(){ data.push(["**","**","**","**","**","**"]); draw(); }
function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); alert("Full Database Saved!"); }
function closePopup(){ document.getElementById("popup").style.display="none"; document.getElementById("overlay").style.display="none"; }

document.getElementById("csv").onchange = e => {
    let fr = new FileReader();
    fr.onload = () => {
        data = fr.result.split('\n').filter(l=>l.trim()).map(l => l.split(',').map(v => norm(v.trim())));
        draw();
    };
    fr.readAsText(e.target.files[0]);
};

draw();
</script>
</body>
</html>
