<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rajdhani Pro AI ‚Äì V10 Ultra Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #ffd700; --blue: #00d2ff; --bg: #0b0f19; --panel: #161b2a; }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { margin: 0; background: var(--bg); color: #fff; text-align: center; }
        
        /* Toolbar */
        .nav { background: var(--panel); padding: 12px; border-bottom: 3px solid var(--gold); display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; position: sticky; top: 0; z-index: 100; }
        .btn { padding: 10px 15px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-upload { background: var(--blue); color: #000; }
        .btn-save { background: #28a745; color: #fff; }
        .btn-reset { background: #dc3545; color: #fff; }

        /* Main Table */
        .table-container { position: relative; background: #fff; border-radius: 10px; padding: 5px; margin: 20px auto; display: inline-block; box-shadow: 0 0 40px rgba(0,0,0,0.8); }
        table { border-collapse: collapse; color: #000; font-size: 15px; position: relative; z-index: 5; }
        td, th { border: 1px solid #ccc; padding: 10px; text-align: center; font-weight: 900; width: 48px; height: 48px; cursor: pointer; }
        th { background: #161b2a; color: #fff; font-size: 11px; }
        
        /* Highlight and Connections */
        .active-cell { border: 3.5px solid #ff0055 !important; border-radius: 50% !important; background: rgba(255, 0, 85, 0.2); position: relative; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 4; }

        /* Dashboard Boxes */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; padding: 15px; max-width: 1100px; margin: 0 auto; }
        .card { background: var(--panel); padding: 15px; border-radius: 12px; border-top: 4px solid var(--gold); }
        .card h3 { margin: 0 0 10px 0; color: var(--gold); font-size: 13px; text-transform: uppercase; letter-spacing: 1px; }

        .check-line { background: rgba(255,255,255,0.05); padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 5px solid var(--blue); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .check-line:hover { background: rgba(255,255,255,0.1); }
        
        #future-box { font-size: 32px; color: #00ff88; font-weight: 900; letter-spacing: 2px; }

        /* Popup */
        #popup { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border-radius: 15px; display: none; z-index: 1000; padding: 20px; color: #000; width: 95%; max-width: 450px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; z-index: 999; }
    </style>
</head>
<body>

<div class="nav">
    <input type="file" id="csv-input" style="display:none" accept=".csv">
    <button class="btn btn-upload" onclick="document.getElementById('csv-input').click()">üìÇ UPLOAD CSV</button>
    <button class="btn" style="background:#555; color:#fff;" onclick="addRow()">‚ûï ADD ROW</button>
    <button class="btn btn-save" onclick="saveToLocal()">üíæ SAVE</button>
    <button class="btn btn-reset" onclick="hardReset()">üóëÔ∏è RESET ALL</button>
</div>

<div class="table-container" id="main-wrapper">
    <canvas id="lineCanvas"></canvas>
    <table id="mainTable"></table>
</div>

<div class="dashboard">
    <div class="card">
        <h3>‚úî Historical Match Lines</h3>
        <div id="checks-list">Click any ** cell to analyze</div>
    </div>
    <div class="card">
        <h3>üîÆ Future AI Prediction (Top 4)</h3>
        <div id="future-box">...</div>
    </div>
</div>

<div class="overlay" id="popupOverlay" onclick="closePop()"></div>
<div id="popup">
    <button onclick="closePop()" style="float:right; background:red; color:#fff; border:none; padding:5px 10px; cursor:pointer;">X</button>
    <h3 style="margin-top:0;">Pattern Trace View</h3>
    <div class="table-container" style="border:1px solid #ccc; display:block;">
        <canvas id="popCanvas"></canvas>
        <div id="popContent"></div>
    </div>
</div>

<script>
// Logic Constants
const FAMILY = {"22":["22","27","72","77"],"11":["11","61","66","16"],"33":["33","83","88","38"],"99":["99","44","49","94"],"55":["00","05","50","55"],"12":["12","17","21","26","62","67","71","76"],"13":["13","18","31","36","63","68","81","86"],"14":["14","19","41","46","64","69","91","96"],"15":["01","06","10","15","51","56","60","65"],"23":["23","28","32","37","73","78","82","87"],"24":["24","29","42","47","74","79","92","97"],"25":["02","07","20","25","52","57","70","75"],"34":["34","39","43","48","84","89","93","98"],"35":["03","08","30","35","53","58","80","85"],"45":["04","09","40","45","54","59","90","95"]};
const KEY = "pdata_Rajdhani_v10"; // New Key to force fresh start

let tableData = JSON.parse(localStorage.getItem(KEY)) || Array(15).fill().map(()=>Array(5).fill("**"));
let currentPattern = null;

function getFamily(val){ val=String(val).padStart(2,'0'); for(let k in FAMILY) if(FAMILY[k].includes(val)) return k; return "NA"; }
function checkMatch(a, b){ if(a=="**" || b=="**" || !a || !b) return false; return getFamily(a) === getFamily(b); }

function renderTable() {
    let html = "<tr><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th></tr>";
    tableData.forEach((row, rIdx) => {
        html += "<tr>";
        row.forEach((cell, cIdx) => {
            let isActive = currentPattern && currentPattern.mask[rIdx - currentPattern.start] && currentPattern.mask[rIdx - currentPattern.start][cIdx];
            html += `<td class="${isActive ? 'active-cell' : ''}" contenteditable="true" oninput="tableData[${rIdx}][${cIdx}]=this.innerText.trim()" onclick="startAnalysis(${rIdx},${cIdx})">${cell}</td>`;
        });
        html += "</tr>";
    });
    document.getElementById("mainTable").innerHTML = html;
    if(currentPattern) setTimeout(() => drawPatternLines("lineCanvas", "mainTable"), 50);
}

function startAnalysis(r, c) {
    if(tableData[r][c] !== "**" && tableData[r][c] !== "") return;

    // Reset UI
    currentPattern = null;
    document.getElementById("future-box").innerHTML = "Analyzing...";
    document.getElementById("checks-list").innerHTML = "Searching...";

    // 1. Get Base Pair (same column, up to 10 rows back)
    let base = "**";
    for(let i=r-1; i>=Math.max(0, r-10); i--) { if(tableData[i][c] !== "**") { base = tableData[i][c]; break; } }
    if(base === "**") return alert("No data above for pattern!");

    // 2. Create Pattern Mask (Last 5 Rows)
    let startPos = Math.max(0, r-5);
    let mask = [];
    for(let i=startPos; i<=r; i++) {
        let rowMask = [];
        for(let j=0; j<5; j++) { rowMask.push(tableData[i][j] !== "**" && checkMatch(tableData[i][j], base) ? 1 : 0); }
        mask.push(rowMask);
    }

    currentPattern = { start: startPos, mask: mask, col: c, base: base };

    // 3. Search Historical Data
    let matches = [];
    for(let i=0; i <= tableData.length - mask.length; i++) {
        if(i === startPos) continue;
        let isFound = true;
        for(let k=0; k < mask.length; k++) {
            for(let j=0; j < 5; j++) {
                if(mask[k][j] && !checkMatch(tableData[i+k][j], base)) { isFound = false; break; }
            }
            if(!isFound) break;
        }
        if(isFound) matches.push(i);
    }

    // 4. Populate Results
    let pool = [];
    let checksHtml = "";
    matches.forEach(mIdx => {
        let nextRow = mIdx + mask.length;
        let resVal = (tableData[nextRow]) ? tableData[nextRow][c] : "**";
        if(resVal !== "**") pool.push(resVal);

        checksHtml += `<div class="check-line" onclick="openTrace(${mIdx})">
            <span>Match at Row ${mIdx+1}</span> <b style="color:var(--gold)">Jodi: ${resVal}</b>
        </div>`;
    });

    document.getElementById("checks-list").innerHTML = checksHtml || "No similar patterns found.";
    let final4 = [...new Set(pool)].slice(0, 4);
    document.getElementById("future-box").innerHTML = final4.length ? final4.join(" - ") : "NONE";

    renderTable();
}

function openTrace(idx) {
    let mask = currentPattern.mask;
    let html = "<table>";
    for(let i=0; i<mask.length; i++) {
        html += "<tr>";
        tableData[idx+i].forEach((v, j) => {
            html += `<td class="${mask[i][j] ? 'active-cell' : ''}">${v}</td>`;
        });
        html += "</tr>";
    }
    document.getElementById("popContent").innerHTML = html + "</table>";
    document.getElementById("popup").style.display = "block";
    document.getElementById("popupOverlay").style.display = "block";
    setTimeout(() => drawPatternLines("popCanvas", "popContent"), 100);
}

function drawPatternLines(cvsId, containerId) {
    let cv = document.getElementById(cvsId), ctx = cv.getContext("2d");
    let container = (typeof containerId === 'string' ? document.getElementById(containerId) : containerId);
    if(!container) return;
    cv.width = container.offsetWidth; cv.height = container.offsetHeight;
    ctx.clearRect(0,0,cv.width,cv.height);
    let points = container.querySelectorAll(".active-cell");
    if(points.length < 2) return;
    let rect = container.getBoundingClientRect();
    ctx.strokeStyle = "#ff0055"; ctx.lineWidth = 4; ctx.beginPath();
    points.forEach((p, i) => {
        let r = p.getBoundingClientRect();
        let x = r.left - rect.left + r.width/2;
        let y = r.top - rect.top + r.height/2;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

function addRow() { tableData.push(["**","**","**","**","**"]); renderTable(); }
function saveToLocal() { localStorage.setItem(KEY, JSON.stringify(tableData)); alert("Data Saved!"); }
function hardReset() { if(confirm("This will clear everything. Proceed?")){ localStorage.clear(); location.reload(); }}
function closePop() { document.getElementById("popup").style.display="none"; document.getElementById("popupOverlay").style.display="none"; }

document.getElementById("csv-input").onchange = e => {
    let reader = new FileReader();
    reader.onload = (ev) => {
        let lines = ev.target.result.split('\n').filter(l=>l.trim());
        tableData = lines.map(l => l.split(',').map(v => v.trim()).slice(0,5));
        renderTable();
        alert("CSV Uploaded!");
    };
    reader.readAsText(e.target.files[0]);
};

window.onload = renderTable;
</script>
</body>
</html>
