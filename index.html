<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalyan AI Pattern - Final Logic</title>
<style>
    :root { --gold: #ffd700; --red: #ff0000; --bg: #121212; --panel: #1e1e1e; }
    body { font-family: sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 10px; }
    
    .header { text-align: center; color: var(--gold); border-bottom: 2px solid #333; margin-bottom: 10px; }
    .toolbar { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px; }
    
    .table-container { position: relative; background: #fff; display: inline-block; border: 2px solid #555; }
    table { border-collapse: collapse; color: #000; font-size: 14px; }
    td, th { border: 1px solid #999; width: 40px; height: 40px; text-align: center; font-weight: bold; position: relative; }
    th { background: #600; color: #fff; font-size: 11px; }
    
    /* ‡§∏‡•ç‡§™‡•á‡§∂‡§≤ ‡§ï‡•ç‡§≤‡§æ‡§∏: ‡§ú‡§¨ ‡§™‡•à‡§ü‡§∞‡•ç‡§® ‡§Æ‡•à‡§ö ‡§π‡•ã */
    .circle { background: var(--red) !important; color: #fff !important; border-radius: 50%; z-index: 5; }
    .highlight-blue { background: #007bff !important; color: #fff !important; border-radius: 50%; }
    .blank { background: #ddd !important; cursor: crosshair; }

    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 15px; }
    .card { background: var(--panel); padding: 12px; border-radius: 8px; border-left: 4px solid var(--gold); }
    
    #checks div { background: #2c3e50; margin: 4px 0; padding: 8px; border-radius: 4px; cursor: pointer; transition: 0.3s; }
    #checks div:hover { background: #34495e; color: var(--gold); }

    canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 4; }
    button { background: var(--gold); color: #000; border: none; padding: 8px 12px; font-weight: bold; border-radius: 4px; cursor: pointer; }
    
    #popup { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border: 4px solid var(--gold); display: none; z-index: 100; padding: 10px; color: #000; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; z-index: 95; }
</style>
</head>
<body>

<div class="header"><h3>üèÜ KALYAN AI PATTERN (V6-PRO)</h3></div>

<div class="toolbar">
    <button onclick="addRow()">‚ûï ‡§∞‡•ã ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
    <button onclick="saveData()" style="background:#28a745; color:#fff;">üíæ ‡§∏‡•á‡§µ</button>
    <button onclick="clearData()" style="background:#d9534f; color:#fff;">üóëÔ∏è ‡§°‡§ø‡§≤‡•Ä‡§ü</button>
    <input type="file" id="csv" style="display:none" onchange="loadCSV(this)">
    <button onclick="document.getElementById('csv').click()">üìÇ ‡§≤‡•ã‡§°</button>
</div>

<center>
    <div class="table-container">
        <canvas id="mainCanvas"></canvas>
        <table id="tbl"></table>
    </div>
</center>

<div class="dashboard">
    <div class="card">
        <h3>üìç ‡§Æ‡•à‡§ö ‡§≤‡§ø‡§∏‡•ç‡§ü (Historical)</h3>
        <div id="checks">‡§ñ‡§æ‡§≤‡•Ä ‡§ú‡§ó‡§π ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç...</div>
    </div>
    <div class="card">
        <h3>ü§ñ AI ‡§™‡•à‡§ü‡§∞‡•ç‡§® ‡§≤‡•â‡§ú‡§ø‡§ï</h3>
        <div id="logicInfo">‡§™‡•à‡§ü‡§∞‡•ç‡§® ‡§ï‡•Ä ‡§ó‡§π‡§∞‡§æ‡§à ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡•á‡§ó‡•Ä...</div>
    </div>
    <div class="card">
        <h3>üîÆ ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä (Future)</h3>
        <div id="future" style="font-size: 28px; color: var(--gold); font-weight: bold; text-align: center;">--</div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div id="popup">
    <button onclick="closePopup()" style="float:right; background:red; color:#fff; border:none;">X</button>
    <div id="popContent"></div>
</div>

<script>
const STORAGE_KEY = "kalyan_v6_final";
let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [
    ["51","91","41","57","19","95"],
    ["05","90","74","06","19","63"],
    ["90","34","82","09","28","19"],
    ["**","**","**","**","**","**"]
];

const families = {"12":["12","17","21","26","62","67","71","76"],"13":["13","18","31","36","63","68","81","86"],"14":["14","19","41","46","64","69","91","96"],"15":["01","06","10","15","51","56","60","65"],"23":["23","28","32","37","73","78","82","87"],"24":["24","29","42","47","74","79","92","97"],"25":["02","07","20","25","52","57","70","75"],"34":["34","39","43","48","84","89","93","98"],"35":["03","08","30","35","53","58","80","85"],"45":["04","09","40","45","54","59","90","95"],"HR":["05","16","27","38","49","50","61","72","83","94"],"FR":["00","11","22","33","44","55","66","77","88","99"]};

let activePattern = null;
let currentTargetCol = null;

function norm(v) { v = String(v).trim(); return (v === "" || v === "**") ? "**" : (v.length === 1 ? "0"+v : v); }

function isMatch(a, b) {
    if(a === "**" || b === "**") return false;
    if(a === b || a === b.split('').reverse().join('')) return true;
    for(let k in families) { if(families[k].includes(a) && families[k].includes(b)) return true; }
    return false;
}

function draw() {
    let h = "<tr><th>‡§∏‡•ã‡§Æ</th><th>‡§Æ‡§Ç‡§ó‡§≤</th><th>‡§¨‡•Å‡§ß</th><th>‡§ó‡•Å‡§∞‡•Å</th><th>‡§∂‡•Å‡§ï‡•ç‡§∞</th><th>‡§∂‡§®‡§ø</th></tr>";
    data.forEach((r, ri) => {
        h += "<tr>";
        r.forEach((c, ci) => {
            let cls = "";
            if (activePattern && isPartOfPattern(ri, ci)) cls = "circle";
            if (c === "**") cls += " blank";
            h += `<td class="${cls}" contenteditable="true" oninput="edit(${ri},${ci},this)" 
                  onclick="${c === '**' ? `startAI(${ri},${ci})` : ''}">${c}</td>`;
        });
        h += "</tr>";
    });
    document.getElementById("tbl").innerHTML = h;
    if(activePattern) setTimeout(() => drawConnections("mainCanvas", "tbl"), 60);
}

function isPartOfPattern(ri, ci) {
    if(!activePattern) return false;
    return activePattern.points.some(p => p.r === ri && p.c === ci);
}

function startAI(r, c) {
    currentTargetCol = c;
    let points = [];
    // 1. ‡§™‡§ø‡§õ‡§≤‡•á 4 ‡§π‡•û‡•ç‡§§‡•ã‡§Ç ‡§ï‡•á ‡§°‡•á‡§ü‡§æ ‡§∏‡•á "‡§∞‡§ø‡§≤‡•á‡§∂‡§®" ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç
    for (let i = 1; i <= 4; i++) {
        let checkRow = r - i;
        if (checkRow < 0) break;
        for (let j = 0; j < 6; j++) {
            if (data[checkRow][j] !== "**") {
                points.push({ r: checkRow, c: j, val: data[checkRow][j], dr: i, dc: j - c });
            }
        }
    }
    searchSystem(points, r, c);
}

function searchSystem(points, originalR, originalC) {
    let matches = [];
    // ‡§™‡•Ç‡§∞‡•á ‡§ö‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§á‡§∏ 'DNA' ‡§ï‡•ã ‡§ñ‡•ã‡§ú‡•á‡§Ç
    for (let i = 0; i < data.length; i++) {
        let currentPoints = [];
        let score = 0;
        
        points.forEach(p => {
            let targetR = i - p.dr;
            let targetC = originalC + p.dc;
            if (data[targetR] && data[targetR][targetC] && isMatch(data[targetR][targetC], p.val)) {
                score++;
                currentPoints.push({ r: targetR, c: targetC });
            }
        });

        if (score >= 2) { // ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 2 ‡§™‡•â‡§á‡§Ç‡§ü ‡§Æ‡•à‡§ö ‡§π‡•ã‡§®‡•á ‡§ö‡§æ‡§π‡§ø‡§è
            matches.push({ startRow: i, points: currentPoints, score: score });
        }
    }
    updateDashboard(matches, points);
}

function updateDashboard(matches, originalPoints) {
    let list = document.getElementById("checks");
    list.innerHTML = "";
    let predictions = [];

    matches.sort((a,b) => b.score - a.score).forEach(m => {
        let div = document.createElement("div");
        div.innerText = `üî• ‡§Æ‡•à‡§ö ‡§∏‡•ç‡§ï‡•ã‡§∞: ${m.score} (‡§∞‡•ã: ${m.startRow + 1})`;
        div.onclick = () => {
            activePattern = { points: m.points };
            draw();
            // ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§ï‡•Ä ‡§ú‡•ã‡§°‡§º‡•Ä ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç
            if(data[m.startRow] && data[m.startRow][currentTargetCol] !== "**") {
                document.getElementById("future").innerText = data[m.startRow][currentTargetCol];
            }
        };
        list.appendChild(div);
    });

    document.getElementById("logicInfo").innerHTML = `‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§®‡•á ${matches.length} ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•à‡§ü‡§∞‡•ç‡§® ‡§™‡§ï‡•ú‡•á ‡§π‡•à‡§Ç‡•§ ‡§∏‡§¨‡§∏‡•á ‡§ä‡§™‡§∞ ‡§µ‡§æ‡§≤‡§æ ‡§∏‡§¨‡§∏‡•á ‡§∏‡§ü‡•Ä‡§ï ‡§π‡•à‡•§`;
}

function drawConnections(canvasId, tableId) {
    const cvs = document.getElementById(canvasId);
    const tbl = document.getElementById(tableId);
    const ctx = cvs.getContext("2d");
    cvs.width = tbl.offsetWidth; cvs.height = tbl.offsetHeight;
    ctx.clearRect(0,0, cvs.width, cvs.height);

    const circles = tbl.querySelectorAll(".circle");
    if(circles.length < 2) return;

    ctx.strokeStyle = "rgba(0,150,255,0.8)";
    ctx.lineWidth = 2;
    let rect = tbl.getBoundingClientRect();

    circles.forEach((c, i) => {
        if(i === 0) return;
        let r1 = circles[0].getBoundingClientRect();
        let r2 = c.getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(r1.left - rect.left + r1.width/2, r1.top - rect.top + r1.height/2);
        ctx.lineTo(r2.left - rect.left + r2.width/2, r2.top - rect.top + r2.height/2);
        ctx.stroke();
    });
}

function edit(r,c,el) { data[r][c] = norm(el.innerText); }
function addRow() { data.push(["**","**","**","**","**","**"]); draw(); }
function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); alert("‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ!"); }
function clearData() { if(confirm("‡§∏‡§¨ ‡§Æ‡§ø‡§ü‡§æ ‡§¶‡•á‡§Ç?")) { localStorage.clear(); location.reload(); }}
function closePopup() { document.getElementById("popup").style.display="none"; document.getElementById("overlay").style.display="none"; }

draw();
</script>
</body>
</html>
