<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalyan AI Pro ‚Äì Ultimate</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
    :root { --gold: #ffd700; --blue: #3e84ff; --red: #ff3e3e; --bg: #121212; --panel: #1e1e1e; }
    body { font-family: 'Segoe UI', Arial; background: var(--bg); color: #fff; margin: 0; padding: 10px; }
    h2 { color: var(--gold); text-align: center; text-transform: uppercase; margin: 5px 0; font-size: 1.2rem; }
    .toolbar { background: var(--panel); padding: 10px; border-radius: 8px; border: 1px solid #444; margin-bottom: 10px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
    .table-container { position: relative; display: inline-block; background: #fff; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.5); padding: 5px; }
    table { border-collapse: collapse; font-size: 12px; position: relative; z-index: 2; color: #000; }
    td, th { border: 1px solid #ccc; padding: 8px 4px; text-align: center; font-weight: bold; width: 35px; height: 35px; }
    th { background: #800000; color: white; }
    .f1 { border: 2.5px solid var(--blue) !important; border-radius: 100%; background: rgba(62, 132, 255, 0.1); }
    .f2 { border: 2.5px solid var(--red) !important; border-radius: 100%; background: rgba(255, 62, 62, 0.1); }
    .blank { background: #e0e0e0 !important; cursor: pointer; }
    .dashboard { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .card { background: var(--panel); padding: 10px; border-radius: 8px; border-left: 4px solid var(--gold); flex: 1; min-width: 250px; }
    canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 3; }
    button { background: var(--gold); color: #000; border: none; padding: 8px 12px; font-weight: bold; border-radius: 4px; cursor: pointer; }
    #popup { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border: 3px solid var(--gold); display: none; z-index: 100; padding: 15px; border-radius: 8px; color: #000; box-shadow: 0 0 50px rgba(0,0,0,0.9); }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 90; }
</style>
</head>
<body>

<h2>üèÜ Kalyan AI ‚Äì CSV & Pattern Pro</h2>

<div class="toolbar">
    <input type="file" id="csvFile" accept=".csv" style="display:none">
    <button onclick="document.getElementById('csvFile').click()" style="background:#6f42c1; color:white;">üìÇ Upload CSV</button>
    <button onclick="addRow()">‚ûï Row</button>
    <button onclick="saveData()" style="background:#28a745; color:white;">üíæ Save</button>
    <button onclick="exportImage()" style="background:#17a2b8; color:white;">üì∏ Screenshot</button>
    <button onclick="clearData()" style="background:#dc3545; color:white;">üóëÔ∏è Reset</button>
</div>

<center>
    <div id="captureArea" class="table-container">
        <canvas id="mainCanvas"></canvas>
        <table id="tbl"></table>
    </div>
</center>

<div class="dashboard">
    <div class="card"><h3>üéØ Matches (Max 3)</h3><div id="checks"></div></div>
    <div class="card"><h3>üîÆ Future AI Prediction</h3><div id="future">Select match...</div></div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div id="popup">
    <button onclick="closePopup()" style="float:right; background:#800000; color:white;">X</button>
    <h3>Connection Detail</h3>
    <div id="popData"></div>
</div>

<script>
const STORAGE_KEY="pdata_kalyan_final_v5";
const families={  
    "22":["22","27","72","77"],"11":["11","61","66","16"],"33":["33","83","88","38"],"99":["99","44","49","94"],"55":["50","00","05","55"],
    "12":["12","17","21","26","62","67","71","76"],"13":["13","18","31","36","63","68","81","86"],"14":["14","19","41","46","64","69","91","96"],
    "15":["01","06","10","15","51","56","60","65"],"23":["23","28","32","37","73","78","82","87"],"24":["24","29","42","47","74","79","92","97"],
    "25":["02","07","20","25","52","57","70","75"],"34":["34","39","43","48","84","89","93","98"],"35":["03","08","30","35","53","58","80","85"],
    "45":["04","09","40","45","54","59","90","95"]
};

function fam(v){for(let k in families) if(families[k].includes(v)) return k; return "NA";}
function norm(v){if(!v || v=="" || v=="**") return "**"; v=String(v).trim(); return v.length==1?"0"+v:v;}

// --- LOCAL STORAGE LOGIC ---
let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [
    ["51","91","41","57","19","95"],
    ["05","90","74","06","19","63"],
    ["90","34","82","09","28","19"],
    ["11","17","86","44","00","25"],
    ["**","**","**","**","**","**"]
];
data = data.map(r => r.map(norm));

let activeMark=null;
let lastTargetCol=0;

function draw(){
    let h="<tr><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr>";
    data.forEach((r,ri)=>{
        h+="<tr>";
        r.forEach((c,ci)=>{
            let p = isPartOfPattern(ri, ci);
            let cls = p ? (p === 1 ? "f1" : "f2") : "";
            if(c=="**") cls += " blank";
            h+=`<td class="${cls}" contenteditable oninput="edit(${ri},${ci},this)" onclick="${c=='**'?'makePattern('+ri+','+ci+')':'' }">${c}</td>`;
        });
        h+="</tr>";
    });
    document.getElementById("tbl").innerHTML=h;
    if(activeMark) setTimeout(() => drawLines("mainCanvas", document.getElementById("tbl")), 50);
}

// --- CSV UPLOAD LOGIC ---
document.getElementById('csvFile').addEventListener('change', function(e) {
    let file = e.target.files[0];
    let reader = new FileReader();
    reader.onload = function(event) {
        let text = event.target.result;
        let rows = text.split('\n').filter(row => row.trim() !== '');
        data = rows.map(row => row.split(',').map(norm));
        draw();
        alert("CSV Data Uploaded!");
    };
    reader.readAsText(file);
});

function isPartOfPattern(ri, ci){
    if(!activeMark) return null;
    let i = ri - activeMark.start;
    if(i >= 0 && i < activeMark.shape.length) return activeMark.shape[i][ci] || null;
    return null;
}

function drawLines(cvsId, tblEl) {
    const cvs = document.getElementById(cvsId);
    const ctx = cvs.getContext("2d");
    cvs.width = tblEl.offsetWidth; cvs.height = tblEl.offsetHeight;
    ctx.clearRect(0,0,cvs.width,cvs.height);
    const tRect = tblEl.getBoundingClientRect();
    const drawFor = (cls, color) => {
        const els = Array.from(tblEl.querySelectorAll("."+cls));
        if(els.length === 2) {
            const r1 = els[0].getBoundingClientRect(); const r2 = els[1].getBoundingClientRect();
            ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.beginPath();
            ctx.moveTo(r1.left-tRect.left+r1.width/2, r1.top-tRect.top+r1.height/2);
            ctx.lineTo(r2.left-tRect.left+r2.width/2, r2.top-tRect.top+r2.height/2);
            ctx.stroke();
        }
    };
    drawFor("f1", "#3e84ff"); drawFor("f2", "#ff3e3e");
}

function makePattern(r,c){
    lastTargetCol = c;
    let famPositions = {};
    
    // SCAN LOGIC: Ab ye aapke click kiye gaye column 'c' ke aas-paas focus karega
    // Hum sirf wahi families uthayenge jo aapke target area ke kareeb hain
    for(let i=Math.max(0, r-6); i<=r; i++){
        // Pehle target column 'c' ko check karo, fir baaki columns ko
        let checkOrder = [c, 0, 1, 2, 3, 4, 5]; 
        for(let j of checkOrder){
            let v = data[i][j];
            if(v !== "**"){
                let f = fam(v);
                if(!famPositions[f]) famPositions[f] = [];
                if(famPositions[f].length < 2) famPositions[f].push({ri:i, ci:j});
            }
        }
    }

    // TOP FAMILIES: Sirf wahi 2 families jo current context mein sabse pehle mili
    let topFams = Object.keys(famPositions).filter(f => famPositions[f].length === 2).slice(0, 2);
    
    if(topFams.length < 2) { 
        alert("Is area/column ke hisab se 2 families nahi mil rahi hain. Thoda data aur bhariye!"); 
        return; 
    }

    // SHAPE BUILDING: Ab shape har click ke liye unique hogi
    let startRow = Math.max(0, r-6);
    let shapeHeight = r - startRow + 1;
    let shape = Array.from({length: shapeHeight}, () => Array(6).fill(0));

    topFams.forEach((f, idx) => {
        famPositions[f].forEach(p => {
            // Check if position is within our current shape height
            if(p.ri >= startRow) {
                shape[p.ri - startRow][p.ci] = (idx + 1);
            }
        });
    });

    searchPattern(shape, topFams);
}
}

function searchPattern(shape, famList){
    let matches = [];
    for(let i=0; i <= data.length-shape.length; i++){
        let ok = true;
        for(let k=0; k<shape.length; k++){
            for(let j=0; j<6; j++){
                if(shape[k][j] === 1 && fam(data[i+k][j]) !== famList[0]) ok = false;
                if(shape[k][j] === 2 && fam(data[i+k][j]) !== famList[1]) ok = false;
                if(!ok) break;
            }
            if(!ok) break;
        }
        if(ok) matches.push({index: i});
    }
    showMatches(shape, matches.slice(0, 3));
}

function showMatches(shape, matches){
    const container = document.getElementById("checks");
    container.innerHTML = matches.length ? "" : "No Combo Found";
    matches.forEach((m, i) => {
        let d = document.createElement("button");
        d.style = "background:#333; color:gold; border:1px solid #444; width:100%; text-align:left; padding:10px; margin-bottom:5px; cursor:pointer;";
        d.innerText = `Match #${i+1} (Row ${m.index + 1})`;
        d.onclick = () => { 
            activeMark = {start: m.index, shape: shape}; 
            draw(); 
            openPopup(m.index, shape);
            predictFuture(matches);
        };
        container.appendChild(d);
    });
}

function predictFuture(matches) {
    let pool = [];
    matches.forEach(m => {
        let nextRow = m.index + activeMark.shape.length;
        if(nextRow < data.length && data[nextRow][lastTargetCol] !== "**") pool.push(data[nextRow][lastTargetCol]);
    });
    document.getElementById("future").innerHTML = pool.length ? `<b>AI Recommendation:</b> ${[...new Set(pool)].join(", ")}` : "No future data";
}

function openPopup(idx, shape) {
    let html = "<table>";
    for(let i=0; i<shape.length; i++) {
        html += "<tr>";
        data[idx+i].forEach((v, j) => {
            let cls = shape[i][j] === 1 ? "f1" : (shape[i][j] === 2 ? "f2" : "");
            html += `<td class="${cls}">${v}</td>`;
        });
        html += "</tr>";
    }
    document.getElementById("popData").innerHTML = html + "</table>";
    document.getElementById("popup").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function exportImage() {
    html2canvas(document.querySelector("#captureArea")).then(canvas => {
        let link = document.createElement('a');
        link.download = 'kalyan_ai_pattern.png';
        link.href = canvas.toDataURL();
        link.click();
    });
}

function closePopup() { document.getElementById("popup").style.display = "none"; document.getElementById("overlay").style.display = "none"; }
function edit(r,c,el){ data[r][c]=norm(el.innerText.trim()); }
function addRow(){ data.push(["**","**","**","**","**","**"]); draw(); }
function saveData(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(data)); alert("Data Saved Locally!"); }
function clearData(){ if(confirm("Clear everything?")){ localStorage.clear(); location.reload(); }}

draw();
</script>
</body>
</html>
