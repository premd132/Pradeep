<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalyan Pro ‚Äì AI Pattern System</title>
<style>
    :root { --gold: #ffd700; --blue: #007bff; --red: #ff3e3e; --bg: #121212; --panel: #1e1e1e; }
    body { font-family: 'Segoe UI', Arial; background: var(--bg); color: #fff; margin: 0; padding: 10px; }
    
    h2 { color: var(--gold); text-align: center; text-transform: uppercase; margin: 5px 0; font-size: 1.2rem; text-shadow: 0 0 10px rgba(255,215,0,0.3); }
    
    .toolbar { background: var(--panel); padding: 10px; border-radius: 8px; border: 1px solid #444; margin-bottom: 10px; display: flex; gap: 8px; justify-content: center; }
    
    .table-container { position: relative; background: #fff; border-radius: 5px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.8); display: inline-block; }
    table { border-collapse: collapse; font-size: 14px; position: relative; z-index: 2; color: #000; }
    td, th { border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold; width: 40px; height: 40px; }
    th { background: #800000; color: white; font-size: 11px; }
    
    /* Highlight Classes */
    .blank { background: #f0f0f0 !important; color: #bbb; }
    .circle { position: relative; z-index: 5; color: #fff !important; background: var(--red) !important; border-radius: 50%; box-shadow: 0 0 8px var(--red); }
    .match-highlight { background: #fffbe6; }
    
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px; }
    .card { background: var(--panel); padding: 12px; border-radius: 8px; border-top: 3px solid var(--gold); }
    .card h3 { margin: 0 0 10px 0; color: var(--gold); font-size: 14px; text-transform: uppercase; }
    
    #checks div { background: #333; margin: 5px 0; padding: 8px; cursor: pointer; border-radius: 4px; font-size: 12px; transition: 0.2s; }
    #checks div:hover { background: #444; color: var(--gold); }
    
    canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 4; }
    button { background: var(--gold); color: #000; border: none; padding: 8px 15px; font-weight: bold; border-radius: 4px; cursor: pointer; }
    
    #popup { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border: 4px solid var(--gold); display: none; z-index: 100; padding: 15px; border-radius: 12px; color: #000; width: 90%; max-width: 450px; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; z-index: 90; }
</style>
</head>
<body>

<h2>üèÜ Kalyan AI Pattern Decoder</h2>

<div class="toolbar">
    <input type="file" id="csv" style="display:none">
    <button onclick="document.getElementById('csv').click()">üìÇ LOAD CSV</button>
    <button onclick="addRow()">‚ûï NEW ROW</button>
    <button onclick="saveData()" style="background:#28a745; color:white;">üíæ SAVE</button>
    <button onclick="clearData()" style="background:#dc3545; color:white;">üóëÔ∏è RESET</button>
</div>

<center>
    <div class="table-container" id="mainWrapper">
        <canvas id="mainCanvas"></canvas>
        <table id="tbl"></table>
    </div>
</center>

<div class="dashboard">
    <div class="card">
        <h3>üéØ Found Matches</h3>
        <div id="checks">Click blank cell to analyze...</div>
    </div>
    
    <div class="card">
        <h3>üìä Match Statistics</h3>
        <div id="ai">Ready for input...</div>
    </div>
    
    <div class="card">
        <h3>üîÆ AI Prediction</h3>
        <div id="future" style="font-weight: bold; color: var(--gold);">Waiting for pattern...</div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div id="popup">
    <button onclick="closePopup()" style="float:right; background:#800000; color:white; border-radius:50%; width:30px; height:30px;">X</button>
    <h3 id="popTitle" style="margin-top:0;">Pattern Logic View</h3>
    <div class="table-container" style="width:100%; border:1px solid #ddd;">
        <canvas id="popCanvas"></canvas>
        <div id="popData"></div>
    </div>
</div>

<script>
const STORAGE_KEY = "kalyan_ai_v3";
let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [
    ["51","91","41","57","19","95"],
    ["05","90","74","06","19","63"],
    ["90","34","82","09","28","19"],
    ["**","**","**","**","**","**"]
];

const families = {
    "12":["12","17","21","26","62","67","71","76"],
    "13":["13","18","31","36","63","68","81","86"],
    "14":["14","19","41","46","64","69","91","96"],
    "15":["01","06","10","15","51","56","60","65"],
    "23":["23","28","32","37","73","78","82","87"],
    "24":["24","29","42","47","74","79","92","97"],
    "25":["02","07","20","25","52","57","70","75"],
    "34":["34","39","43","48","84","89","93","98"],
    "35":["03","08","30","35","53","58","80","85"],
    "45":["04","09","40","45","54","59","90","95"],
    "HR":["05","16","27","38","49","50","61","72","83","94"],
    "FR":["00","11","22","33","44","55","66","77","88","99"]
};

let activePattern = null;
let currentTargetCol = null;

function norm(v) { 
    v = String(v).trim();
    if(v === "" || v === "**") return "**";
    return v.length === 1 ? "0"+v : v;
}

function getFamily(v) {
    for(let k in families) if(families[k].includes(v)) return k;
    return null;
}

function isSmartMatch(a, b) {
    if(a === "**" || b === "**") return false;
    if(a === b || a === b.split('').reverse().join('')) return true;
    return getFamily(a) === getFamily(b);
}

function draw() {
    let h = "<tr><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr>";
    data.forEach((r, ri) => {
        h += "<tr>";
        r.forEach((c, ci) => {
            let isTarget = (activePattern && isCellInPattern(ri, ci)) ? "circle" : "";
            let isBlank = (c === "**") ? "blank" : "";
            h += `<td class="${isTarget} ${isBlank}" contenteditable="true" 
                  oninput="edit(${ri},${ci},this)" 
                  onclick="${c === '**' ? `startAnalysis(${ri},${ci})` : ''}">${c}</td>`;
        });
        h += "</tr>";
    });
    document.getElementById("tbl").innerHTML = h;
    if(activePattern) setTimeout(() => drawPatternLines("mainCanvas", "tbl"), 100);
}

function isCellInPattern(ri, ci) {
    if(!activePattern) return false;
    let offset = ri - activePattern.startRow;
    return (offset >= 0 && offset < activePattern.shape.length && activePattern.shape[offset][ci]);
}

function startAnalysis(r, c) {
    currentTargetCol = c;
    // Look back for last non-blank jodi in this column
    let baseJodi = "**";
    for(let i = r-1; i >= 0; i--) {
        if(data[i][c] !== "**") { baseJodi = data[i][c]; break; }
    }
    
    if(baseJodi === "**") { alert("No base jodi found above!"); return; }

    // Logic: Create shape based on last 4 rows from current point
    let shape = [];
    let startLook = Math.max(0, r - 3);
    for(let i = startLook; i <= r; i++) {
        let rowShape = [];
        for(let j = 0; j < 6; j++) {
            rowShape.push(data[i][j] !== "**" && isSmartMatch(data[i][j], baseJodi) ? 1 : 0);
        }
        shape.push(rowShape);
    }
    findMatches(shape, baseJodi);
}

function findMatches(shape, base) {
    let matches = [];
    for(let i = 0; i <= data.length - shape.length; i++) {
        let score = 0;
        let totalDots = 0;
        shape.forEach((row, ri) => {
            row.forEach((cell, ci) => {
                if(cell) {
                    totalDots++;
                    if(isSmartMatch(data[i+ri][ci], base)) score++;
                }
            });
        });
        if(score > 0 && score === totalDots) matches.push(i);
    }
    displayResults(shape, matches, base);
}

function displayResults(shape, matches, base) {
    let container = document.getElementById("checks");
    container.innerHTML = "";
    
    matches.forEach((startRow, index) => {
        let div = document.createElement("div");
        div.innerHTML = `üî• Pattern Found at Row ${startRow + 1}`;
        div.onclick = () => {
            activePattern = {startRow, shape, base};
            draw();
            showPopupPattern(startRow, shape);
        };
        container.appendChild(div);
    });

    // AI Prediction Logic
    let predictions = [];
    matches.forEach(m => {
        let nextRow = m + shape.length;
        if(data[nextRow] && data[nextRow][currentTargetCol] !== "**") {
            predictions.push(data[nextRow][currentTargetCol]);
        }
    });

    document.getElementById("future").innerHTML = predictions.length ? 
        `Expected: ${[...new Set(predictions)].join(" / ")}` : "Not enough historical data";
}

function drawPatternLines(canvasId, tableId) {
    const canvas = document.getElementById(canvasId);
    const table = document.getElementById(tableId);
    const ctx = canvas.getContext("2d");
    canvas.width = table.offsetWidth;
    canvas.height = table.offsetHeight;
    ctx.clearRect(0,0, canvas.width, canvas.height);

    const circles = table.querySelectorAll(".circle");
    if(circles.length < 2) return;

    ctx.strokeStyle = "rgba(0, 123, 255, 0.8)";
    ctx.lineWidth = 2;
    ctx.setLineDash([5, 3]);

    let first = circles[0].getBoundingClientRect();
    let tableRect = table.getBoundingClientRect();

    circles.forEach(el => {
        let rect = el.getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(first.left - tableRect.left + first.width/2, first.top - tableRect.top + first.height/2);
        ctx.lineTo(rect.left - tableRect.left + rect.width/2, rect.top - tableRect.top + rect.height/2);
        ctx.stroke();
    });
}

function showPopupPattern(rowIdx, shape) {
    let html = "<table id='popTbl'>";
    for(let i=0; i < shape.length; i++) {
        html += "<tr>";
        data[rowIdx + i].forEach((val, j) => {
            let cls = shape[i][j] ? "circle" : "";
            html += `<td class="${cls}">${val}</td>`;
        });
        html += "</tr>";
    }
    document.getElementById("popData").innerHTML = html + "</table>";
    document.getElementById("popup").style.display = "block";
    document.getElementById("overlay").style.display = "block";
    setTimeout(() => drawPatternLines("popCanvas", "popTbl"), 100);
}

function edit(r,c,el) { data[r][c] = norm(el.innerText); }
function addRow() { data.push(["**","**","**","**","**","**"]); draw(); }
function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); alert("Data Saved Successfully!"); }
function clearData() { if(confirm("Delete all data?")) { localStorage.clear(); location.reload(); } }
function closePopup() { document.getElementById("popup").style.display = "none"; document.getElementById("overlay").style.display = "none"; }

draw();
</script>
</body>
</html>
