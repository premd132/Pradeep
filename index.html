<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Milan Pro V45 - Dynamic Market Days</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #ffd700; --blue: #0084ff; --red: #ff3131; --green: #00ff88; --bg: #0f172a; --panel: #1e293b; }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: #fff; padding: 10px; }
        
        .tabs { display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; }
        .tab-btn { padding: 12px 10px; border: none; border-radius: 8px; background: #334155; color: white; font-weight: bold; cursor: pointer; flex: 1; font-size: 11px; }
        .tab-btn.active { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); }

        .toolbar { background: var(--panel); padding: 12px; border-radius: 12px; display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; border: 1px solid #334155; }
        .btn { background: #444; color: #fff; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 11px; }

        .table-container { position: relative; background: #fff; border-radius: 10px; padding: 10px; display: inline-block; box-shadow: 0 0 25px rgba(0,0,0,0.6); }
        table { border-collapse: collapse; color: #000; font-size: 13px; position: relative; z-index: 10; }
        td, th { border: 1px solid #ccc; width: 42px; height: 42px; text-align: center; font-weight: 800; cursor: pointer; }
        th { background: #1e293b; color: white; cursor: default; font-size: 9px; }

        .circle-b { border: 4px solid var(--blue) !important; border-radius: 8px; background: rgba(0,132,255,0.1); }
        .circle-r { border: 4px solid var(--red) !important; border-radius: 8px; background: rgba(255,49,49,0.1); }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 5; }

        .card { background: var(--panel); padding: 15px; border-radius: 12px; border-top: 3px solid var(--gold); margin-top: 15px; max-width: 600px; margin-inline: auto; }
        .pair-chip { background: var(--gold); color: #000; padding: 8px 15px; border-radius: 50px; font-weight: 900; font-size: 1.1rem; display: inline-block; margin: 5px; }
        .check-item { background: #2a3a50; padding: 10px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; border-left: 5px solid var(--blue); font-size: 12px; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; z-index: 100; }
        #popup { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border-radius: 20px; display: none; z-index: 101; padding: 20px; color: #000; width: 95%; max-width: 450px; text-align: center; }
    </style>
</head>
<body>

<div class="tabs">
    <button class="tab-btn active" onclick="switchMarket('MILAN', this)">MILAN (6D)</button>
    <button class="tab-btn" onclick="switchMarket('KALYAN', this)">KALYAN (6D)</button>
    <button class="tab-btn" onclick="switchMarket('RAJDHANI', this)">RAJDHANI (5D)</button>
</div>

<div class="toolbar">
    <input type="file" id="csvIn" style="display:none" onchange="importCSV(this)">
    <button class="btn" onclick="document.getElementById('csvIn').click()">üìÇ CSV</button>
    <button class="btn" onclick="addRow()">‚ûï ROW</button>
    <button class="btn" style="background:var(--green); color:#000;" onclick="saveData()">üíæ SAVE <span id="curMarketLabel">MILAN</span></button>
</div>

<center>
    <div class="table-container">
        <canvas id="mainCvs"></canvas>
        <table id="tbl"></table>
    </div>
</center>

<div class="card" style="text-align:center; background: linear-gradient(135deg, #1e293b, #0c121d);">
    <h3 id="marketTitle" style="color:var(--gold); margin:0;">üîÆ MILAN FUTURE AI</h3>
    <div id="prediction-box" style="margin-top:10px;"><span style="color:#666;">Waiting for click...</span></div>
</div>

<div class="card">
    <h3 style="color:var(--gold); margin:0 0 10px 0; font-size:14px;">üîç PATTERN EVIDENCE</h3>
    <div id="check-list">Click a blank cell...</div>
</div>

<div class="overlay" id="overlay" onclick="closePop()"></div>
<div id="popup">
    <h3 id="popHead">Evidence</h3>
    <div class="table-container" style="border:1px solid #ddd;">
        <canvas id="popCvs"></canvas>
        <div id="popContent"></div>
    </div>
    <button onclick="closePop()" style="margin-top:15px; padding:10px 25px; background:red; color:white; border:none; border-radius:5px;">CLOSE</button>
</div>

<script>
let currentMarket = "MILAN";
let colCount = 6;
let markets = {
    "MILAN": JSON.parse(localStorage.getItem("Milan_V45")) || Array(10).fill(Array(6).fill("**")),
    "KALYAN": JSON.parse(localStorage.getItem("Kalyan_V45")) || Array(10).fill(Array(6).fill("**")),
    "RAJDHANI": JSON.parse(localStorage.getItem("Raj_V45")) || Array(10).fill(Array(5).fill("**"))
};

const families={"12":["12","17","21","26","62","67","71","76"],"13":["13","18","31","36","63","68","81","86"],"14":["14","19","41","46","64","69","91","96"],"15":["01","06","10","15","51","56","60","65"],"23":["23","28","32","37","73","78","82","87"],"24":["24","29","42","47","74","79","92","97"],"25":["02","07","20","25","52","57","70","75"],"34":["34","39","43","48","84","89","93","98"],"35":["03","08","30","35","53","58","80","85"],"45":["04","09","40","45","54","59","90","95"],"HR":["05","16","27","38","49","50","61","72","83","94"],"FR":["00","11","22","33","44","55","66","77","88","99"]};

function switchMarket(m, btn) {
    currentMarket = m;
    colCount = (m === "RAJDHANI") ? 5 : 6;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('curMarketLabel').innerText = m;
    document.getElementById('marketTitle').innerText = `üîÆ ${m} FUTURE AI`;
    draw();
}

function fam(v){for(let k in families) if(families[k].includes(v)) return k; return "NA";}
function norm(v){ v=String(v).replace(/[^0-9]/g,''); return v.length==1?"0"+v:(v||"**");}

function draw(targetId="tbl", sourceData=markets[currentMarket], pattern=null) {
    let days = ["MON","TUE","WED","THU","FRI","SAT"].slice(0, colCount);
    let h="<tr>" + days.map(d=>`<th>${d}</th>`).join('') + "</tr>";
    
    sourceData.forEach((r, ri) => {
        h+="<tr>";
        r.slice(0, colCount).forEach((c, ci) => {
            let type = (pattern && ri >= pattern.start && ri < pattern.start + pattern.matrix.length) ? pattern.matrix[ri-pattern.start][ci] : 0;
            let cls = type==1 ? "circle-b" : (type==2 ? "circle-r" : "");
            h+=`<td class="${cls}" onclick="handleCellClick(${ri},${ci},'${c}')">${c}</td>`;
        });
        h+="</tr>";
    });
    document.getElementById(targetId).innerHTML=h;
    setTimeout(()=>drawLines(targetId=="tbl"?"mainCvs":"popCvs", targetId), 60);
}

function handleCellClick(r, c, val) {
    if(val !== "**") {
        let n = prompt("Edit "+currentMarket+" Jodi:", val);
        if(n !== null) { markets[currentMarket][r][c] = norm(n); draw(); }
    } else {
        processAI(r, c);
    }
}

function drawLines(cId, tId) {
    const cvs=document.getElementById(cId), tbl=document.getElementById(tId), ctx=cvs.getContext("2d");
    if(!tbl) return;
    cvs.width=tbl.offsetWidth; cvs.height=tbl.offsetHeight; ctx.clearRect(0,0,cvs.width,cvs.height);
    const cells=tbl.querySelectorAll(".circle-b, .circle-r");
    ctx.strokeStyle="#00ff88"; ctx.lineWidth=3; ctx.beginPath();
    cells.forEach((c,i)=>{ 
        const r=c.getBoundingClientRect(), tr=tbl.getBoundingClientRect();
        const x=r.left-tr.left+r.width/2, y=r.top-tr.top+r.height/2;
        if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

function processAI(r, c) {
    let db = markets[currentMarket];
    let b1="**", b2="**", b1R=-1;
    for(let i=r; i>=0; i--){ if(db[i][c]!="**"){ b1=db[i][c]; b1R=i; break; } }
    if(b1=="**") return;
    for(let i=b1R-1; i>=0; i--){
        for(let j=0; j<colCount; j++){ if(db[i][j]!="**" && fam(db[i][j])!==fam(b1)){ b2=db[i][j]; break; } }
        if(b2!="**") break;
    }

    let matrix=[]; let c1=0, c2=0;
    let sRow = Math.max(0, r-8);
    for(let i=sRow; i<=r; i++){
        let row=Array(colCount).fill(0);
        for(let j=0; j<colCount; j++){
            if(db[i][j]!="**"){
                if(fam(db[i][j])==fam(b1) && c1<2){ row[j]=1; c1++; }
                else if(b2!=="**" && fam(db[i][j])==fam(b2) && c2<2){ row[j]=2; c2++; }
            }
        }
        matrix.push(row);
    }
    draw("tbl", db, {start: sRow, matrix: matrix});

    // History Scan (Strict Family) [cite: 2026-02-03]
    let matches = [];
    for(let i=0; i < db.length - matrix.length - 1; i++) {
        if(i >= sRow) continue;
        let hB1="**", ok=true;
        for(let k=0; k<matrix.length; k++){
            for(let j=0; j<colCount; j++){
                if(matrix[k][j]==1){
                    if(hB1=="**") hB1=db[i+k][j];
                    else if(fam(db[i+k][j])!==fam(hB1)) ok=false;
                }
            }
        }
        if(ok && hB1!=="**") matches.push({idx: i});
    }

    const list = document.getElementById("check-list");
    list.innerHTML = "";
    matches.slice(0,3).forEach((m, idx)=>{
        let d = document.createElement("div"); d.className="check-item";
        d.innerHTML=`<b>Line ${idx+1}:</b> ${currentMarket} Row ${m.idx+1} (Flow Match)`;
        d.onclick=()=>showPopup(m.idx, matrix);
        list.appendChild(d);
    });

    // Final AI Prediction [cite: 2026-02-03]
    let f1 = families[fam(b1)];
    let f2 = families[fam(b2)] || families["FR"];
    document.getElementById("prediction-box").innerHTML = `
        <div class="pair-chip">${f1[0]}</div>
        <div class="pair-chip">${f2[1]}</div>
        <div class="pair-chip">${families["FR"][Math.floor(Math.random()*10)]}</div>
    `;
}

function showPopup(idx, matrix) {
    document.getElementById("overlay").style.display="block";
    document.getElementById("popup").style.display="block";
    document.getElementById("popContent").innerHTML='<table id="popTbl"></table>';
    draw("popTbl", markets[currentMarket].slice(idx, idx + matrix.length + 1), {start: 0, matrix: matrix});
}

function closePop() { document.getElementById("overlay").style.display="none"; document.getElementById("popup").style.display="none"; }
function addRow() { markets[currentMarket].push(Array(colCount).fill("**")); draw(); }
function saveData() { 
    localStorage.setItem(currentMarket+"_V45", JSON.stringify(markets[currentMarket])); 
    alert(currentMarket + " (Strict Structure) Saved!"); 
}
function importCSV(i){
    let r=new FileReader(); r.onload=(e)=>{ 
        markets[currentMarket]=e.target.result.split('\n').filter(l=>l.trim()).map(l=>l.split(',').map(v=>norm(v.trim()))); 
        draw(); 
    }; r.readAsText(i.files[0]);
}

draw();
</script>
</body>
</html>
