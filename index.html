<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalyan Pro AI ‚Äì Advanced Pattern System</title>
<style>
    :root { --gold: #ffd700; --blue: #007bff; --red: #ff3e3e; --bg: #0f0f0f; --panel: #1a1a1a; }
    body { font-family: 'Segoe UI', Arial; background: var(--bg); color: #fff; margin: 0; padding: 10px; }
    
    .header-box { text-align: center; border-bottom: 2px solid var(--gold); margin-bottom: 15px; padding-bottom: 10px; }
    h2 { color: var(--gold); text-transform: uppercase; margin: 5px 0; letter-spacing: 2px; }

    .toolbar { background: var(--panel); padding: 10px; border-radius: 8px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px; }
    
    .table-container { position: relative; background: #fff; border-radius: 8px; overflow: hidden; display: inline-block; box-shadow: 0 0 25px rgba(0,0,0,0.5); }
    table { border-collapse: collapse; font-size: 14px; position: relative; z-index: 2; color: #000; }
    td, th { border: 1px solid #bbb; padding: 10px; text-align: center; font-weight: bold; width: 45px; height: 45px; }
    th { background: #4a0000; color: white; font-size: 12px; }
    
    .blank { background: #f9f9f9 !important; color: #ccc; cursor: cell; }
    .circle { position: relative; z-index: 5; color: #fff !important; background: var(--red) !important; border-radius: 50%; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 62, 62, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 62, 62, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 62, 62, 0); } }

    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
    .card { background: var(--panel); padding: 15px; border-radius: 10px; border-left: 5px solid var(--gold); box-shadow: 5px 5px 15px rgba(0,0,0,0.3); }
    .card h3 { margin: 0 0 12px 0; color: var(--gold); border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 16px; }
    
    .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
    .highlight-ank { color: var(--gold); font-size: 18px; font-weight: bold; }

    canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 4; }
    button { background: var(--gold); color: #000; border: none; padding: 10px 18px; font-weight: bold; border-radius: 5px; cursor: pointer; transition: 0.3s; }
    button:hover { transform: scale(1.05); background: #fff; }

    #popup { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border: 5px solid var(--gold); display: none; z-index: 100; padding: 20px; border-radius: 15px; color: #000; width: 95%; max-width: 500px; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 90; }
</style>
</head>
<body>

<div class="header-box">
    <h2>üèÜ KALYAN AI PATTERN PRO 2026</h2>
</div>

<div class="toolbar">
    <button onclick="addRow()">‚ûï ‡§®‡§à ‡§∞‡•ã ‡§ú‡•ã‡•ú‡•á‡§Ç</button>
    <button onclick="saveData()" style="background:#28a745; color:white;">üíæ ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
    <button onclick="clearData()" style="background:#dc3545; color:white;">üóëÔ∏è ‡§∏‡§¨ ‡§∏‡§æ‡•û ‡§ï‡§∞‡•á‡§Ç</button>
    <input type="file" id="csv" style="display:none">
    <button onclick="document.getElementById('csv').click()">üìÇ CSV ‡§≤‡•ã‡§°</button>
</div>

<center>
    <div class="table-container">
        <canvas id="mainCanvas"></canvas>
        <table id="tbl"></table>
    </div>
</center>

<div class="dashboard">
    <div class="card">
        <h3>üéØ ‡§Æ‡§ø‡§≤‡•á ‡§π‡•Å‡§è ‡§Æ‡•à‡§ö (Patterns)</h3>
        <div id="checks">‡§ï‡§ø‡§∏‡•Ä ‡§ñ‡§æ‡§≤‡•Ä ‡§∏‡•á‡§≤ (**) ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç...</div>
    </div>
    
    <div class="card">
        <h3>üî¢ AI Ank Analysis (Single)</h3>
        <div id="ankStat">
            <div class="stat-row">‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§ì‡§™‡§®: <span id="favOpen" class="highlight-ank">-</span></div>
            <div class="stat-row">‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§ï‡•ç‡§≤‡•ã‡§ú: <span id="favClose" class="highlight-ank">-</span></div>
            <div class="stat-row">‡§Æ‡§ú‡§¨‡•Ç‡§§ ‡§Ö‡§Ç‡§ï: <span id="strongAnk" class="highlight-ank">-</span></div>
        </div>
    </div>
    
    <div class="card">
        <h3>üîÆ ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§ï‡•Ä ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä</h3>
        <div id="future" style="font-size: 20px; color: var(--gold); text-align: center; margin-top: 10px;">
            ‡§°‡•á‡§ü‡§æ ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞...
        </div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div id="popup">
    <button onclick="closePopup()" style="float:right; background:#800000; color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer;">X</button>
    <h3 style="margin-top:0;">Pattern Logic View</h3>
    <div class="table-container" style="width:100%; border:1px solid #ddd;">
        <canvas id="popCanvas"></canvas>
        <div id="popData"></div>
    </div>
</div>

<script>
const STORAGE_KEY = "kalyan_v3_adv";
let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [
    ["51","91","41","57","19","95"],
    ["05","90","74","06","19","63"],
    ["90","34","82","09","28","19"],
    ["**","**","**","**","**","**"]
];

const families = {"12":["12","17","21","26","62","67","71","76"],"13":["13","18","31","36","63","68","81","86"],"14":["14","19","41","46","64","69","91","96"],"15":["01","06","10","15","51","56","60","65"],"23":["23","28","32","37","73","78","82","87"],"24":["24","29","42","47","74","79","92","97"],"25":["02","07","20","25","52","57","70","75"],"34":["34","39","43","48","84","89","93","98"],"35":["03","08","30","35","53","58","80","85"],"45":["04","09","40","45","54","59","90","95"],"HR":["05","16","27","38","49","50","61","72","83","94"],"FR":["00","11","22","33","44","55","66","77","88","99"]};

let activePattern = null;
let currentTargetCol = null;

function norm(v) { 
    v = String(v).trim();
    if(v === "" || v === "**") return "**";
    return v.length === 1 ? "0"+v : v;
}

// Logic 1: Family Match
function getFamily(v) {
    for(let k in families) if(families[k].includes(v)) return k;
    return null;
}

// Logic 2: Total Sum Match (e.g. 51 => 5+1=6)
function getTotal(v) {
    if(v === "**") return -1;
    return (parseInt(v[0]) + parseInt(v[1])) % 10;
}

function isSmartMatch(a, b) {
    if(a === "**" || b === "**") return false;
    if(a === b || a === b.split('').reverse().join('')) return true; // Direct or Palti
    if(getFamily(a) === getFamily(b)) return true; // Family
    if(getTotal(a) === getTotal(b)) return true; // Total/Sum
    return false;
}

function draw() {
    let h = "<tr><th>‡§∏‡•ã‡§Æ</th><th>‡§Æ‡§Ç‡§ó‡§≤</th><th>‡§¨‡•Å‡§ß</th><th>‡§ó‡•Å‡§∞‡•Å</th><th>‡§∂‡•Å‡§ï‡•ç‡§∞</th><th>‡§∂‡§®‡§ø</th></tr>";
    data.forEach((r, ri) => {
        h += "<tr>";
        r.forEach((c, ci) => {
            let isTarget = (activePattern && isCellInPattern(ri, ci)) ? "circle" : "";
            let isBlank = (c === "**") ? "blank" : "";
            h += `<td class="${isTarget} ${isBlank}" contenteditable="true" 
                  oninput="edit(${ri},${ci},this)" 
                  onclick="${c === '**' ? `startAnalysis(${ri},${ci})` : ''}">${c}</td>`;
        });
        h += "</tr>";
    });
    document.getElementById("tbl").innerHTML = h;
    if(activePattern) setTimeout(() => drawPatternLines("mainCanvas", "tbl"), 100);
}

function isCellInPattern(ri, ci) {
    if(!activePattern) return false;
    let offset = ri - activePattern.startRow;
    return (offset >= 0 && offset < activePattern.shape.length && activePattern.shape[offset][ci]);
}

function startAnalysis(r, c) {
    currentTargetCol = c;
    let baseJodi = "**";
    for(let i = r-1; i >= 0; i--) { if(data[i][c] !== "**") { baseJodi = data[i][c]; break; } }
    
    if(baseJodi === "**") return;

    let shape = [];
    let startLook = Math.max(0, r - 4); // Scan up to 5 rows back
    for(let i = startLook; i <= r; i++) {
        let rowShape = [];
        for(let j = 0; j < 6; j++) {
            rowShape.push(data[i][j] !== "**" && isSmartMatch(data[i][j], baseJodi) ? 1 : 0);
        }
        shape.push(rowShape);
    }
    findMatches(shape, baseJodi);
}

function findMatches(shape, base) {
    let matches = [];
    for(let i = 0; i <= data.length - shape.length; i++) {
        let score = 0, totalDots = 0;
        shape.forEach((row, ri) => {
            row.forEach((cell, ci) => {
                if(cell) {
                    totalDots++;
                    if(isSmartMatch(data[i+ri][ci], base)) score++;
                }
            });
        });
        if(score > 0 && score === totalDots) matches.push(i);
    }
    processAI(shape, matches);
}

function processAI(shape, matches) {
    let container = document.getElementById("checks");
    container.innerHTML = "";
    
    let nextJodis = [], opens = [], closes = [], anks = [];

    matches.forEach((startRow) => {
        let div = document.createElement("div");
        div.style.cssText = "background:#333; margin:5px; padding:8px; cursor:pointer; border-radius:5px;";
        div.innerHTML = `üìç ‡§™‡•à‡§ü‡§∞‡•ç‡§® ‡§Æ‡§ø‡§≤‡§æ: ‡§∞‡•ã ‡§®‡§Ç‡§¨‡§∞ ${startRow + 1}`;
        div.onclick = () => {
            activePattern = {startRow, shape};
            draw();
            showPopupPattern(startRow, shape);
        };
        container.appendChild(div);

        // Collect Future Data
        let nextRowIdx = startRow + shape.length;
        if(data[nextRowIdx] && data[nextRowIdx][currentTargetCol] !== "**") {
            let jodi = data[nextRowIdx][currentTargetCol];
            nextJodis.push(jodi);
            opens.push(jodi[0]);
            closes.push(jodi[1]);
            anks.push(jodi[0], jodi[1]);
        }
    });

    // Update Stats
    const top = (arr) => arr.length ? arr.sort((a,b) => arr.filter(v => v===a).length - arr.filter(v => v===b).length).pop() : "-";
    
    document.getElementById("favOpen").innerText = top(opens);
    document.getElementById("favClose").innerText = top(closes);
    document.getElementById("strongAnk").innerText = top(anks);
    document.getElementById("future").innerText = nextJodis.length ? nextJodis.join(" , ") : "‡§°‡•á‡§ü‡§æ ‡§ï‡§Æ ‡§π‡•à";
}

function drawPatternLines(canvasId, tableId) {
    const canvas = document.getElementById(canvasId);
    const table = document.getElementById(tableId);
    const ctx = canvas.getContext("2d");
    canvas.width = table.offsetWidth;
    canvas.height = table.offsetHeight;
    ctx.clearRect(0,0, canvas.width, canvas.height);

    const circles = table.querySelectorAll(".circle");
    if(circles.length < 2) return;

    ctx.strokeStyle = "gold";
    ctx.lineWidth = 2;
    let tableRect = table.getBoundingClientRect();

    for(let i=0; i<circles.length-1; i++) {
        let r1 = circles[i].getBoundingClientRect();
        let r2 = circles[i+1].getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(r1.left - tableRect.left + r1.width/2, r1.top - tableRect.top + r1.height/2);
        ctx.lineTo(r2.left - tableRect.left + r2.width/2, r2.top - tableRect.top + r2.height/2);
        ctx.stroke();
    }
}

function showPopupPattern(rowIdx, shape) {
    let html = "<table>";
    for(let i=0; i < shape.length; i++) {
        html += "<tr>";
        data[rowIdx + i].forEach((val, j) => {
            html += `<td class="${shape[i][j] ? 'circle' : ''}">${val}</td>`;
        });
        html += "</tr>";
    }
    document.getElementById("popData").innerHTML = html + "</table>";
    document.getElementById("popup").style.display = "block";
    document.getElementById("overlay").style.display = "block";
    setTimeout(() => drawPatternLines("popCanvas", "popData table"), 100);
}

function edit(r,c,el) { data[r][c] = norm(el.innerText); }
function addRow() { data.push(["**","**","**","**","**","**"]); draw(); }
function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); alert("‡§°‡•á‡§ü‡§æ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à!"); }
function clearData() { if(confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) { localStorage.clear(); location.reload(); } }
function closePopup() { document.getElementById("popup").style.display = "none"; document.getElementById("overlay").style.display = "none"; }

document.getElementById("csv").onchange = e => {
    let fr = new FileReader();
    fr.onload = () => {
        data = fr.result.split('\n').filter(l=>l.trim()).map(l => l.split(',').map(v => norm(v)));
        draw();
    };
    fr.readAsText(e.target.files[0]);
};

draw();
</script>
</body>
</html>
