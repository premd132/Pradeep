<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kalyan Pro AI ‚Äì Pradeep Kumar System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #ffd700; --blue: #0084ff; --green: #00ff88; --bg: #0f172a; --panel: #1e293b; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Poppins', sans-serif; }
        #main-app { padding: 15px; }
        
        .toolbar { background: var(--panel); padding: 10px; border-radius: 10px; margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; }
        button { cursor: pointer; border-radius: 5px; border: none; font-weight: bold; padding: 8px 12px; }

        .table-container { position: relative; background: #fff; border-radius: 8px; padding: 5px; display: inline-block; }
        table { border-collapse: collapse; color: #000; position: relative; z-index: 5; }
        td, th { border: 1px solid #ccc; padding: 5px; text-align: center; width: 42px; height: 42px; font-weight: 800; font-size: 16px; }
        th { background: #1e293b; color: #fff; font-size: 11px; }

        .circle { border: 3px solid var(--blue) !important; border-radius: 50% !important; background: rgba(0, 132, 255, 0.2); }
        .mark-source { background: #ff4757 !important; color: #fff !important; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 4; }

        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .card { background: var(--panel); padding: 15px; border-radius: 12px; border-top: 3px solid var(--gold); }
        h3 { margin: 0 0 10px 0; color: var(--gold); font-size: 14px; }

        #popup { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border-radius: 15px; display: none; z-index: 100; padding: 15px; color: #000; width: 90%; box-shadow: 0 0 50px #000; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; z-index: 90; }
    </style>
</head>
<body>

<div id="main-app">
    <h2 style="color:var(--gold); margin:0;">Kalyan Pro AI <small style="color:#888; font-size:12px;">v3.0 (Pradeep Ed.)</small></h2>
    
    <div class="toolbar">
        <button onclick="addRow()" style="background:var(--gold);">+ ROW</button>
        <button onclick="saveData()" style="background:#28a745; color:#fff;">SAVE</button>
        <button onclick="clearData()" style="background:#dc3545; color:#fff;">RESET</button>
        <input type="file" id="csv" style="display:none">
        <button onclick="document.getElementById('csv').click()" style="background:#444; color:#fff;">CSV</button>
    </div>

    <center>
        <div class="table-container" id="mainTblBox">
            <canvas id="mainCanvas"></canvas>
            <table id="tbl"></table>
        </div>
    </center>

    <div class="dashboard">
        <div class="card">
            <h3>üîç Pattern Matches (1-2-3 Check)</h3>
            <div id="checks">Click any blank cell (**) to scan...</div>
        </div>
        <div class="card">
            <h3>ü§ñ Future AI (3-Pairs)</h3>
            <div id="future-ai" style="font-size: 24px; color: var(--gold); text-align: center; font-weight: 800;">-- -- --</div>
        </div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div id="popup">
    <button onclick="closePopup()" style="float:right; background:#000; color:#fff;">CLOSE</button>
    <h3 style="color:#000">Pattern Found in Old Records</h3>
    <div class="table-container" style="width:100%; overflow:auto;">
        <canvas id="popCanvas"></canvas>
        <table id="popTbl" style="width:100%"></table>
    </div>
</div>

<script>
const STORAGE_KEY = "pdata_kalyan_v3";
const FAMILY = {"22":["22","27","72","77"],"11":["11","61","66","16"],"33":["33","83","88","38"],"99":["44","49","94","99"],"55":["00","05","50","55"],"12":["12","17","21","26","62","67","71","76"],"13":["13","18","31","36","63","68","81","86"],"14":["14","19","41","46","64","69","91","96"],"15":["01","06","10","15","51","56","60","65"],"23":["23","28","32","37","73","78","82","87"],"24":["24","29","42","47","74","79","92","97"],"25":["02","07","20","25","52","57","70","75"],"34":["34","39","43","48","84","89","93","98"],"35":["03","08","30","35","53","58","80","85"],"45":["04","09","40","45","54","59","90","95"]};

let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || Array(10).fill(["**","**","**","**","**","**"]);
let activeCoords = [];

function norm(v){ v=String(v).trim(); return (v==""||v=="**")?"**":(v.length==1?"0"+v:v); }
function smartMatch(a,b){ if(a=="**"||b=="**") return false; if(a===b || a===b.split('').reverse().join('')) return true; for(let k in FAMILY) if(FAMILY[k].includes(a) && FAMILY[k].includes(b)) return true; return false; }

function draw(){
    let h="<tr><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr>";
    data.forEach((r, ri) => {
        h += "<tr>";
        r.forEach((c, ci) => {
            let cls = activeCoords.some(p => p.r===ri && p.c===ci) ? "circle" : "";
            h += `<td class="${cls}" contenteditable onblur="data[${ri}][${ci}]=norm(this.innerText)" onclick="cellClick(${ri},${ci})">${c}</td>`;
        });
        h += "</tr>";
    });
    document.getElementById("tbl").innerHTML = h;
    if(activeCoords.length > 1) setTimeout(()=>drawLine("mainCanvas", "tbl"), 50);
}

function cellClick(r, c) {
    if(data[r][c] === "**") {
        scanPattern(r, c);
    } else {
        // Trace logic: Where this jodi came from
        activeCoords = [{r:r, c:c}];
        for(let i=r-1; i>=Math.max(0, r-10); i--){
            for(let j=0; j<6; j++){
                if(smartMatch(data[r][c], data[i][j])) activeCoords.push({r:i, c:j});
            }
        }
        draw();
    }
}

function scanPattern(tr, tc) {
    let matches = [];
    let seeds = [
        {r: tr-1, c: tc-1, type: "Cross (L)"},
        {r: tr-1, c: tc,   type: "Straight"},
        {r: tr-1, c: tc+1, type: "Cross (R)"}
    ];

    seeds.forEach(s => {
        if(s.r >=0 && s.c >=0 && s.c < 6 && data[s.r][s.c] !== "**") {
            let val = data[s.r][s.c];
            // Scan last 10 weeks (approx 60 rows)
            for(let i=0; i < s.r; i++) {
                for(let j=0; j<6; j++) {
                    if(smartMatch(data[i][j], val)) {
                        matches.push({oldR: i, oldC: j, type: s.type, nextVal: (data[i+1]?data[i+1][tc]:"00")});
                    }
                }
            }
        }
    });

    let html = "";
    matches.slice(0, 5).forEach(m => {
        html += `<div style="background:#334155; padding:8px; margin-bottom:5px; border-radius:5px; cursor:pointer;" onclick="showOldPattern(${m.oldR}, ${m.oldC})">
                 Found ${m.type} at Row ${m.oldR+1} ‚ûî</div>`;
    });
    document.getElementById("checks").innerHTML = html || "No patterns found in 10 weeks.";
    
    // Future AI Predictions
    let preds = [...new Set(matches.map(m => m.nextVal))].slice(0,3);
    document.getElementById("future-ai").innerHTML = preds.length ? preds.join("  ") : "00 55 99";
}

function showOldPattern(r, c) {
    let h = "";
    let popCoords = [{r:0, c:c}, {r:1, c:c}]; // Basic connection logic
    for(let i=-1; i<=1; i++) {
        if(data[r+i]) {
            h += "<tr>";
            data[r+i].forEach((v, j) => {
                let isCircle = (i===0 && j===c) || (i===1 && j===c); // Show the connection
                h += `<td class="${isCircle?'circle':''}">${v}</td>`;
            });
            h += "</tr>";
        }
    }
    document.getElementById("popTbl").innerHTML = h;
    document.getElementById("popup").style.display="block";
    document.getElementById("overlay").style.display="block";
    setTimeout(()=>drawLine("popCanvas", "popTbl"), 100);
}

function drawLine(cvsId, tblId) {
    let cvs = document.getElementById(cvsId);
    let tbl = document.getElementById(tblId);
    let ctx = cvs.getContext("2d");
    cvs.width = tbl.offsetWidth; cvs.height = tbl.offsetHeight;
    ctx.clearRect(0,0,cvs.width,cvs.height);
    let dots = tbl.querySelectorAll(".circle");
    if(dots.length < 2) return;
    ctx.strokeStyle = "#00ff88"; ctx.lineWidth = 3;
    ctx.beginPath();
    dots.forEach((d, i) => {
        let x = d.offsetLeft + d.offsetWidth/2;
        let y = d.offsetTop + d.offsetHeight/2;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

function addRow() { data.push(["**","**","**","**","**","**"]); draw(); }
function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); alert("Saved!"); }
function clearData() { if(confirm("Clear?")) { localStorage.clear(); location.reload(); } }
function closePopup() { document.getElementById("popup").style.display="none"; document.getElementById("overlay").style.display="none"; }

document.getElementById("csv").onchange = e => {
    let fr = new FileReader();
    fr.onload = () => {
        data = fr.result.split('\n').filter(l=>l.trim()).map(l=>l.split(',').map(v=>norm(v)));
        draw();
    };
    fr.readAsText(e.target.files[0]);
};

draw();
</script>
</body>
</html>
