<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kalyan Pro AI ‚Äì Pradeep Kumar System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #ffd700; 
            --blue-circle: #0084ff; 
            --green-line: #00ff88; 
            --bg: #0f172a; 
            --panel: #1e293b; 
        }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { margin: 0; background: var(--bg); color: #fff; overflow-x: hidden; }

        /* Dashboard & Layout */
        #main-app { padding: 15px; }
        .toolbar { background: var(--panel); padding: 12px; border-radius: 12px; margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; border: 1px solid rgba(255,255,255,0.1); }
        
        .table-container { position: relative; background: #fff; border-radius: 10px; padding: 5px; box-shadow: 0 0 30px rgba(0,0,0,0.5); display: inline-block; }
        table { border-collapse: collapse; color: #000; font-size: 14px; position: relative; z-index: 5; }
        td, th { border: 1px solid #ddd; padding: 8px 4px; text-align: center; font-weight: bold; width: 45px; height: 45px; cursor: pointer; }
        th { background: #1e293b; color: white; }
        
        /* Marking Styles */
        .circle { border: 3px solid var(--blue-circle) !important; border-radius: 50% !important; background: rgba(0, 132, 255, 0.2); position: relative; }
        .source-mark { background: #ff4757 !important; color: white !important; border-radius: 4px; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 4; }

        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
        .card { background: var(--panel); padding: 15px; border-radius: 12px; border-top: 3px solid var(--gold); }
        .card h3 { margin: 0 0 10px 0; color: var(--gold); font-size: 14px; text-transform: uppercase; border-bottom: 1px solid #444; padding-bottom: 5px; }

        /* Popups */
        #popup { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border-radius: 15px; display: none; z-index: 100; padding: 15px; color: #000; width: 95%; max-width: 500px; box-shadow: 0 0 50px #000; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 90; }
        button { cursor: pointer; border-radius: 6px; border: none; font-weight: bold; padding: 8px 15px; transition: 0.2s; }
        button:hover { opacity: 0.8; }
    </style>
</head>
<body>

<div id="main-app">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
        <div>
            <h2 style="color:var(--gold); margin:0;">Kalyan Pro AI</h2>
            <small style="color:#888;">User: Pradeep Kumar Dehariya</small>
        </div>
        <button onclick="addRow()" style="background:var(--gold); color:#000;">+ ADD ROW</button>
    </div>

    <div class="toolbar">
        <input type="file" id="csv" style="display:none">
        <button onclick="document.getElementById('csv').click()" style="background:#444; color:white;">üìÇ LOAD CSV</button>
        <button onclick="saveData()" style="background:#28a745; color:white;">üíæ LOCAL STORAGE</button>
        <button onclick="clearData()" style="background:#dc3545; color:white;">üóëÔ∏è RESET</button>
    </div>

    <center>
        <div class="table-container" id="tblBox">
            <canvas id="mainCanvas"></canvas>
            <table id="tbl"></table>
        </div>
    </center>

    <div class="dashboard">
        <div class="card">
            <h3>üìä Pattern Matches (1,2,3 Check)</h3>
            <div id="checks" style="max-height: 200px; overflow-y: auto;">Click a blank cell to analyze...</div>
        </div>
        <div class="card">
            <h3>ü§ñ Advanced AI Result</h3>
            <div id="ai-advanced">System Ready.</div>
        </div>
        <div class="card">
            <h3>üîÆ Future AI Prediction</h3>
            <div id="future-ai" style="font-size: 1.2rem; color: var(--gold);">---</div>
        </div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div id="popup">
    <button onclick="closePopup()" style="float:right; background:#f00; color:#fff;">X</button>
    <h3 id="popTitle" style="margin-top:0;">Pattern Trace</h3>
    <div class="table-container" style="width:100%; overflow:auto;">
        <canvas id="popCanvas"></canvas>
        <table id="popTbl" style="width:100%"></table>
    </div>
</div>

<script>
const STORAGE_KEY = "pdata_Kalyan_v2";
const FAMILY = {
 "22":["22","27","72","77"], "11":["11","61","66","16"], "33":["33","83","88","38"], "99":["99","44","49","94"], "55":["00","05","50","55"],
 "12":["12","17","21","26","62","67","71","76"], "13":["13","18","31","36","63","68","81","86"], "14":["14","19","41","46","64","69","91","96"],  
 "15":["01","06","10","15","51","56","60","65"], "23":["23","28","32","37","73","78","82","87"], "24":["24","29","42","47","74","79","92","97"],  
 "25":["02","07","20","25","52","57","70","75"], "34":["34","39","43","48","84","89","93","98"], "35":["03","08","30","35","53","58","80","85"],  
 "45":["04","09","40","45","54","59","90","95"]
};

let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || Array(12).fill(["**","**","**","**","**","**"]);
let activePattern = null;

function norm(v){ v=String(v).trim(); if(v==""||v=="**") return "**"; return v.length==1?"0"+v:v; }
function smartMatch(a,b){ if(a=="**"||b=="**") return false; if(a===b || a===b.split('').reverse().join('')) return true; for(let k in FAMILY) if(FAMILY[k].includes(a) && FAMILY[k].includes(b)) return true; return false; }

function draw(){
    let h="<tr><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr>";
    data.forEach((r, ri) => {
        h += "<tr>";
        r.forEach((c, ci) => {
            let cls = "";
            if(activePattern && activePattern.coords.some(p => p.r === ri && p.c === ci)) cls = "circle";
            h += `<td class="${cls}" contenteditable onblur="updateCell(${ri},${ci},this.innerText)" onclick="handleCellClick(${ri},${ci})">${c}</td>`;
        });
        h += "</tr>";
    });
    document.getElementById("tbl").innerHTML = h;
    if(activePattern) setTimeout(() => drawLines("mainCanvas", "tbl"), 50);
}

function updateCell(r,c,v){ data[r][c] = norm(v); }

function handleCellClick(r, c) {
    if(data[r][c] === "**") {
        findPatterns(r, c);
    } else {
        // Mark where this Jodi might have come from (Simple trace)
        highlightSource(r, c);
    }
}

// --- UPDATED CROSS PATTERN LOGIC ---

function findPatterns(targetR, targetC) {
    let matches = [];
    let lookback = 60; // 10 weeks approx (6 days * 10)
    
    // Seed: Row directly above (Straight, Left Cross, Right Cross)
    let seeds = [
        { r: targetR - 1, c: targetC - 1, type: "Left Cross" },
        { r: targetR - 1, c: targetC,     type: "Straight" },
        { r: targetR - 1, c: targetC + 1, type: "Right Cross" }
    ];

    seeds.forEach(s => {
        if (s.r >= 0 && s.c >= 0 && s.c < 6 && data[s.r][s.c] !== "**") {
            let seedValue = data[s.r][s.c];
            
            // Search old records for this seed
            for (let i = 0; i < s.r; i++) {
                for (let j = 0; j < 6; j++) {
                    if (smartMatch(data[i][j], seedValue)) {
                        matches.push({ 
                            row: i, 
                            col: j, 
                            type: s.type,
                            val: seedValue 
                        });
                    }
                }
            }
        }
    });

    displayMatches(matches, targetR, targetC);
}

// --- UPDATED DRAWING FOR CROSS CONNECTIONS ---

function drawLines(canvasId, tableId) {
    const canvas = document.getElementById(canvasId);
    const table = document.getElementById(tableId);
    const ctx = canvas.getContext("2d");
    canvas.width = table.offsetWidth;
    canvas.height = table.offsetHeight;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const circles = table.querySelectorAll(".circle");
    if (circles.length < 2) return;

    ctx.strokeStyle = "#00ff88"; // Green Connection Line
    ctx.lineWidth = 2.5;
    ctx.setLineDash([5, 3]); // Cross patterns ke liye dash line achhi lagti hai
    ctx.beginPath();
    
    let prevX, prevY;
    circles.forEach((el, idx) => {
        let x = el.offsetLeft + el.offsetWidth / 2;
        let y = el.offsetTop + el.offsetHeight / 2;
        if (idx === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    ctx.stroke();
}
draw();
</script>
</body>
</html>
